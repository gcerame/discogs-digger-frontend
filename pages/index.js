/*
    TODO:
     - Move form to component
     - Show errors in UI
        *Empty search params
        *Errors from backend
     - If query is empty it should return early and not call the backend
*/
import { useState } from "react";
import Release from "../components/release";
import { Button, Container, Flex, Input } from "@chakra-ui/react";
import { Header } from "../components/header";

export default function Home () {
    const [releases, setReleases] = useState([]);
    const [error, setError] = useState(null);

    const handleSubmit = async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        if (Object.values(data).every(x => x === '')) {
            setError({ message: 'Please enter search parameters' });
            return;
        }

        Object.keys(data).forEach((key) => data[key] === '' && delete data[key]);
        const searchQuery = new URLSearchParams(data).toString();

        try {
            const APIURL = `http://localhost:3001/search/?${searchQuery}`;
            const response = await fetch(APIURL);
            const fetchedReleases = await response.json();
            if(fetchedReleases.error) {
                setError(fetchedReleases);
                return;
            }
            setReleases(fetchedReleases);

        } catch (e) {
            setError(e);
        }
    };

    const mapReleasesToComponent = () => {
        return releases.map((release) => {
            return (
                <Release release={release} key={release.id}/>
            );
        });
    };

    return (
        <>
            <header>
                <title>discogs-digger</title>
                <meta name="description" content="Generated by create next app"/>
            </header>

            <main>
                <Header/>
                <div className="search-form">
                    <form onSubmit={handleSubmit}>
                        <Flex wrap="wrap" justify="center">
                            <Input minW={175} maxW={200} size="sm" placeholder="Style"
                                id="style"
                                name="style"
                                aria-label="style"/>
                            <Input minW={175} maxW={200} size="sm" placeholder="Year"
                                id="year"
                                name="year"
                                aria-label="year"/>
                            <Input minW={175} maxW={200} size="sm" placeholder="Label"
                                id="label"
                                name="label"
                                aria-label="label"/>
                            <Input minW={175} maxW={200} size="sm" placeholder="Country"
                                id="country"
                                name="country"
                                aria-label="country"/>
                            <Input minW={175} maxW={200} size="sm" placeholder="Artist"
                                id="artist"
                                name="artist"
                                aria-label="artist"/>
                            <Button type="submit">Search</Button></Flex>

                    </form>
                </div>
                <Container centerContent>
                    { error!==null ? <p>{error.message}</p> : mapReleasesToComponent() }
                </Container>
            </main>
        </>);
}
